################################################################################
# Copyright (c) 2019, NVIDIA CORPORATION.  All rights reserved.
#
# NVIDIA Corporation and its licensors retain all intellectual property
# and proprietary rights in and to this software, related documentation
# and any modifications thereto.  Any use, reproduction, disclosure or
# distribution of this software and related documentation without an express
# license agreement from NVIDIA Corporation is strictly prohibited.
#
################################################################################

This project implements protocol adaptor for Azure (device2cloud messaging)
The adaptor implements the nv_dsmi API for client applications to interface with it.

Create azure IOT hub : https://docs.microsoft.com/en-us/azure/iot-hub/tutorial-connectivity
NOTE: Once you have your IOT hub created, please make sure you fill in the connection details in cfg_azure.txt

Dependencies:
------------
 sudo apt-get update
 sudo apt-get install -y libcurl4-openssl-dev libssl-dev uuid-dev libglib2.0 libglib2.0-dev

Azure cfg:
----------
You can add Azure connection and message details in the cfg file.
Uncomment the fields you may want to edit and add proper values

[message-broker]
#connection_str = HostName=<my-hub>.azure-devices.net;DeviceId=<device_id>;SharedAccessKey=<my-policy-key>
#custom_msg_properties =  <key>=<value>;
#share-connection=1

NOTE: DO NOT delete the line [message-broker] inside the cfg file. Its the section identifier used for parsing


Azure device connection string:
-------------------------------
Make sure to provide the connection_str within cfg_azure.txt
 connection_str = HostName=<my-hub>.azure-devices.net;DeviceId=<device_id>;SharedAccessKey=<my-policy-key>

OR

pass in full connection string in the call to nvds_msgapi_connect():
 conn_handle = nvds_msgapi_connect((char *)"HostName=<my-hub>.azure-devices.net;DeviceId=<device_id>;SharedAccessKey=<my-policy-key>",(nvds_msgapi_connect_cb_t) sample_msgapi_connect_cb, (char *)CFG_FILE);

NOTE: If connection string is provided both in call to nvds_msgapi_connect() and also inside cfg file, the string provided in nvds_msgapi_connect() will be used for making connection

Set message properties:
-----------------------
Option to provide custom MQTT / IOT-hub client message properties of format key=value;
Multiple such key value message pairs can be provided
Note: Max length of the custom_msg_property string is limited to 512 bytes
ex1: key1=value1;
ex2: key1=value1;key2=value2;key3=value3;

Share connection
----------------
#share-connection=1
Uncomment the field share-connection in cfg_azure.txt and set its value to 1
if you need to generate a connection signature. This signature is a unique string
which is generated by parsing all the azure connection related params
used for making a connection
Uncommenting this field signifies that the connection created can be shared
with other components within the same process.

Setup and enable logging:
-------------------------
Before running the sample applications, enable logs by running the logger setup script:
For x86,
 chmod u+x ~/deepstream_x86_public/sources/tools/nvds_logger/setup_nvds_logger.sh
 sudo ~/deepstream_x86_public/sources/tools/nvds_logger/setup_nvds_logger.sh
On Jetson,
 chmod u+x ~/deepstream_sdk_on_jetson/sources/tools/nvds_logger/setup_nvds_logger.sh
 sudo ~/deepstream_sdk_on_jetson/sources/tools/nvds_logger/setup_nvds_logger.sh

When the test app starts, log messages from the message adaptors(azure) can be seen at /tmp/nvds/ds.log

To run test program:
--------------------
 make -f Makefile.test
 ./test_azure_proto_async <path_to_libnvds_azure_proto.so>
 ./test_azure_proto_sync <path_to_libnvds_azure_proto.so>

 NOTE:
 1. To compile the sources, run make with "sudo" or root permission.
 2. libnvds_azure_proto.so can be found at /opt/nvidia/deepstream/deepstream-<version>/lib/libnvds_azure_proto.so
